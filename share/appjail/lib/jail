#
# Copyright (c) 2022-2023, Jes√∫s Daniel Colmenares Oviedo <DtxdF@disroot.org>
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# * Redistributions of source code must retain the above copyright notice, this
#   list of conditions and the following disclaimer.
#
# * Redistributions in binary form must reproduce the above copyright notice,
#   this list of conditions and the following disclaimer in the documentation
#   and/or other materials provided with the distribution.
#
# * Neither the name of the copyright holder nor the names of its
#   contributors may be used to endorse or promote products derived from
#   this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

lib_load "${LIBDIR}/check_func"
lib_load "${LIBDIR}/jail_types"
lib_load "${LIBDIR}/mount"
lib_load "${LIBDIR}/log"
lib_load "${LIBDIR}/replace"
lib_load "${LIBDIR}/sysexits"
lib_load "${LIBDIR}/zfs"

lib_jail_exists()
{
	local jail_name="$1"

	if [ -z "${jail_name}" ]; then
		lib_err ${EX_USAGE} "usage: lib_jail_exists jail_name"
	fi

	if jls -j "${jail_name}" > /dev/null 2>&1; then
		return 0
	else
		return 1
	fi
}

lib_jail_created_by_appjail()
{
	local path
	local jail_name="$1"

	if [ -z "${jail_name}" ]; then
		lib_err ${EX_USAGE} "usage: lib_jail_created_by_appjail jail_name"
	fi

	path=`jls -j "${jail_name}" path`
	if [ "${path}" = "${JAILDIR}/${jail_name}/jail" ]; then
		return 0
	else
		return 1
	fi
}

lib_template2jail_conf()
{
	local jail_name
	local template
	local line
	local opt_add
	local parameter value op

	jail_name="$1"
	template="$2"

	if [ -z "${jail_name}" -o -z "${template}" ]; then
		lib_err ${EX_USAGE} "usage: lib_template2jail_conf jail_name template"
	fi

	if [ ! -f "${template}" ]; then
		lib_err ${EX_NOINPUT} "Cannot find the template \`${template}\`."
	fi

	printf "%s {\n" "${jail_name}"

	lib_jail_readtemplate "${template}" | while IFS= read -r line
	do
		parameter=`lib_jailparam_name "${line}" :`
		value=`lib_jailparam_value "${line}" :`

		opt_add=0
		if lib_check_jaillist "${parameter}"; then
			opt_add=1
		fi

		parameter=`_lib_wipe_jailparam "${parameter}"`

		if ! lib_check_jailparam "${parameter}"; then
			lib_err ${EX_DATAERR} "Invalid parameter: ${parameter}"
		fi

		if ! lib_check_empty "${value}"; then
			if [ ${opt_add} -eq 0 ]; then
				op="="
			else
				op="+="
			fi

			value=`lib_jail_tolist "${value}"`

			printf "\t%s %s %s;\n" "${parameter}" "${op}" "${value}"
		else
			printf "\t%s;\n" "${parameter}"
		fi
	done

	printf "}\n"
}

lib_jail_tolist()
{
	local template_list="$1"

	lib_split_jailparams "${template_list}" | sed -Ee 's/"/\\"/g' -e 's/^(.+)$/"\1"/' | tr '\n' ',' | sed -Ee 's/,$/\n/'
}

lib_jail_readtemplate()
{
	local template="$1"
	if [ -z "${template}" ]; then
		lib_err ${EX_USAGE} "usage: lib_jail_readtemplate template"
	fi

	grep -Ev '^[[:space:]]*#' "${template}" | grep -Eve '^[[:space:]]*$' | sed -Ee 's/^[[:space:]]*//'
}

lib_check_reqparams()
{
	local template="$1"
	if [ -z "${template}" ]; then
		lib_err ${EX_USAGE} "usage: lib_check_reqparams template"
	fi

	if [ `lib_jail_readtemplate "${template}" | lib_get_reqparams | wc -l` -gt 0 ]; then
		return 0
	else
		return 1
	fi
}

lib_get_reqparams()
{
	lib_get_jailparam -A | grep -E '^\*'
}

lib_get_jailparam()
{
	local _o

	# options
	local opt_all=0
	local opt_check_only=0
	local opt_ignore_unkvars=0
	local opt_list_columns=0
	local opt_show_name=1
	local opt_show_value=1
	local opt_all_rows=0
	local parameter=
	# column
	local column=0
	# row
	local current_row=-1 row=0

	# misc
	local errlevel=0
	local found=0

	if [ $# -eq 0 ]; then
		lib_err ${EX_USAGE} "usage: lib_get_jailparam -A [-l] | -a parameter [-cilNnP] [-C column] [-R row]"
	fi

	while getopts ":AcilNnPa:C:R:" _o; do
		case "${_o}" in
			A)
				opt_all=1
				;;
			c)
				opt_check_only=1
				;;
			i)
				opt_ignore_unkvars=1
				;;
			l)
				opt_list_columns=1
				;;
			N)
				opt_show_name=1
				opt_show_value=0
				;;
			n)
				opt_show_value=1
				opt_show_name=0
				;;
			P)
				opt_all_rows=1
				;;
			a)
				parameter="${OPTARG}"
				;;
			C)
				column="${OPTARG}"
				;;
			R)
				row="${OPTARG}"
				;;
			*)
				lib_get_jailparam # usage
				;;
		esac
	done

	if [ ${opt_all} -eq 0 ]; then
		if [ -z "${parameter}" ]; then
			lib_get_jailparam # usage
		fi
	fi

	if ! lib_check_number "${column}"; then
		lib_err ${EX_DATAERR} "${column} is an invalid column."
	fi

	if ! lib_check_number "${row}" ; then
		lib_err ${EX_DATAERR} "${row} is an invalid row."
	fi

	if [ ${opt_all} -eq 0 ]; then
		parameter=`lib_jailparam_name "${parameter}" =`
		if ! lib_check_jailparam "${parameter}"; then
			lib_err ${EX_DATAERR} "Invalid parameter: ${parameter}"
		fi
	fi

	local jail_args
	while IFS= read -r jail_args; do
		local jail_parameter=`lib_jailparam_name "${jail_args}" :`
		local jail_parameter_raw=`_lib_wipe_jailparam "${jail_parameter}"`

		if ! lib_check_jailparam "${jail_parameter_raw}"; then
			lib_err ${EX_DATAERR} "Invalid parameter: ${jail_parameter_raw}"
		fi
		
		# All parameters
		if [ ${opt_all} -eq 1 ]; then
			local jail_value=`lib_jailparam_value "${jail_args}" : | sed -Ee 's/^[[:space:]]//'`

			if [ ${opt_list_columns} -eq 1 ]; then
				if lib_check_empty "${jail_value}"; then
					continue
				fi

				lib_split_jailparams "${jail_value}"
			else
				_lib_jailparam_printparam "${jail_parameter}" "${jail_value}" ${opt_show_name} ${opt_show_value}
			fi
			continue
		fi

		# Individual parameters.
		if [ "${parameter}" != "${jail_parameter_raw}" ]; then
			continue
		fi

		current_row=$((current_row+1))

		if [ ${current_row} -ne ${row} ]; then
			if [ ${opt_all_rows} -eq 0 ]; then
				continue
			fi
		fi

		if [ ${opt_check_only} -eq 1 ]; then
			return 0
		fi

		found=1

		local jail_value=`lib_jailparam_value "${jail_args}" : | sed -Ee 's/^[[:space:]]//'`

		if [ ${column} -eq 0 ]; then
			if [ ${opt_list_columns} -eq 1 ]; then
				if lib_check_empty "${jail_value}"; then
					continue
				fi

				lib_split_jailparams "${jail_value}"
			else
				_lib_jailparam_printparam "${jail_parameter}" "${jail_value}" ${opt_show_name} ${opt_show_value}
			fi
			continue
		else
			local columns=`lib_split_jailparams "${jail_value}"`
			local column_value=

			if [ -n "${columns}" ]; then
				column_value=`lib_get_jailcolumn "${columns}" "${column}"`
			fi

			if [ -n "${column_value}" ]; then
				_lib_jailparam_printparam "${jail_parameter}" "${column_value}" ${opt_show_name} ${opt_show_value}
			else
				if [ ${opt_ignore_unkvars} -eq 0 ]; then
					lib_err ${EX_DATAERR} "Column index (${jail_parameter}:(${row}:${column})) out of range."
				fi

				return ${EX_DATAERR}
			fi
		fi

		# Break if all rows are used, since it is not needed to keep looking for new fields.
		if [ ${opt_all_rows} -eq 0 ]; then
			break
		fi
	done

	if [ ${opt_all} -eq 0 -a ${found} -eq 0 ]; then
		if [ ${opt_ignore_unkvars} -eq 0 -a ${opt_check_only} -eq 0 ]; then
			lib_err ${EX_DATAERR} "Unknown variable '${parameter}:(${row}:${column})'"
		fi

		return ${EX_DATAERR}
	fi

	return 0
}

lib_insert_jailparam()
{
	local _o

	# options
	local opt_required=0
	local parameter=

	while getopts ":ra:" _o; do
		case "${_o}" in
			r)
				opt_required=1
				;;
			a)
				parameter="${OPTARG}"
				;;
			*)
				lib_insert_jailparam # usage
				;;
		esac
	done

	if [ -z "${parameter}" ]; then
		lib_insert_jailparam # usage
	fi

	local user_parameter=`lib_jailparam_name "${parameter}" =`
	if ! lib_check_jailparam "${user_parameter}"; then
		lib_err ${EX_DATAERR} "Invalid parameter: ${user_parameter}"
	fi

	local user_value=`lib_jailparam_value "${parameter}" =`

	if [ ${opt_required} -eq 1 ]; then
		user_parameter="*${user_parameter}"
	fi

	printf "%s+: %s\n" "${user_parameter}" "${user_value}"
}

lib_set_jailparam()
{
	local _o

	# options
	local opt_add_column=0
	local opt_required=0
	local parameter=
	local template=
	# column
	local column=0
	# row
	local current_row=-1 row=0

	# misc
	local found=0

	if [ $# -eq 0 ]; then
		lib_err ${EX_USAGE} "usage: lib_set_jailparam -a parameter [-or] [-C column] [-R row]"
	fi

	while getopts ":ora:C:R:" _o; do
		case "${_o}" in
			o)
				opt_add_column=1
				;;
			r)
				opt_required=1
				;;
			a)
				parameter="${OPTARG}"
				;;
			C)
				column="${OPTARG}"
				;;
			R)
				row="${OPTARG}"
				;;
			*)
				lib_set_jailparam # usage
				;;
		esac
	done

	if [ -z "${parameter}" ]; then
		lib_set_jailparam # usage
	fi

	if ! lib_check_number "${column}"; then
		lib_err ${EX_DATAERR} "${column} is an invalid column."
	fi

	if ! lib_check_number "${row}" ; then
		lib_err ${EX_DATAERR} "${row} is an invalid row."
	fi

	local user_parameter=`lib_jailparam_name "${parameter}" =`
	if ! lib_check_jailparam "${user_parameter}"; then
		lib_err ${EX_DATAERR} "Invalid parameter: ${user_parameter}"
	fi

	local user_value=`lib_jailparam_value "${parameter}" =`

	local jail_args
	while IFS= read -r jail_args; do
		# Empty
		if lib_check_empty "${jail_args}"; then
			printf "%s\n" "${jail_args}"
			continue
		fi
		
		# Comments
		if lib_check_comment "${jail_args}"; then
			printf "%s\n" "${jail_args}"
			continue
		fi

		local jail_parameter=`lib_jailparam_name "${jail_args}" :`
		local jail_parameter_raw=`_lib_wipe_jailparam "${jail_parameter}"`

		if ! lib_check_jailparam "${jail_parameter_raw}"; then
			lib_err ${EX_DATAERR} "Invalid parameter: ${jail_parameter_raw}"
		fi

		if [ "${user_parameter}" != "${jail_parameter_raw}" ]; then
			printf "%s\n" "${jail_args}"
			continue
		fi

		current_row=$((current_row+1))

		if [ ${current_row} -ne ${row} ]; then
			printf "%s\n" "${jail_args}"
			continue
		fi

		found=1

		if [ ${opt_required} -eq 1 ] && ! lib_check_jailreq "${jail_parameter}"; then # Add *
			jail_parameter="*${jail_parameter}"
		elif [ ${opt_required} -eq 0 ]; then # Remove *
			jail_parameter=`printf "%s" "${jail_parameter}" | sed -Ee 's/^\*//'`
		fi
		
		if [ ${column} -eq 0 -a ${opt_add_column} -eq 0 ]; then
			printf "%s\n" "${jail_parameter}: ${user_value}"
			continue
		fi

		jail_value=`lib_jailparam_value "${jail_args}" : | sed -Ee 's/^[[:space:]]//'`

		if [ -z "${jail_value}" ]; then
			printf "%s\n" "${jail_parameter}: ${user_value}"
			continue
		fi
		
		if lib_check_empty "${user_value}"; then
			lib_err ${EX_DATAERR} "It is not possible to add an empty value to a list."
		fi
		
		local columns=`lib_split_ujailparams "${jail_value}"`

		printf "%s" "${jail_parameter}: "

		local column_total=`printf "%s\n" "${columns}" | wc -l`

		if [ ${opt_add_column} -eq 1 ]; then
			if [ ${column_total} -eq 0 ]; then
				printf "%s\n" "${user_value}"
			else
				printf "%s %s\n" "${jail_value}" "${user_value}"
			fi

			continue
		fi

		local current_column=0
		printf "%s\n" "${columns}" | while IFS= read -r column_value; do
			current_column=$((current_column+1))

			if [ ${current_column} -ne ${column} ]; then
				printf "%s" "${column_value}"
				if [ ${current_column} -gt 0 -a ${current_column} -lt ${column_total} ]; then
					printf "%s" " "
				fi

				continue
			fi
			
			printf "%s" "${user_value}"
			if [ ${current_column} -lt ${column_total} ]; then
				printf "%s" " "
			fi
		done

		if [ ${column} -gt ${column_total} ]; then
			if [ ${column_total} -gt 0 ]; then
				printf "%s" " "
			fi

			printf "%s\n" "${user_value}"
		else
			echo
		fi
	done

	if [ ${found} -eq 0 ]; then
		if [ ${current_row} -ge 0 ]; then
			user_parameter="${user_parameter}+"
		fi

		if [ ${opt_required} -eq 1 ]; then
			user_parameter="*${user_parameter}"
		fi

		if [ -n "${user_value}" ]; then
			printf "%s\n" "${user_parameter}: ${user_value}"
		else
			printf "%s\n" "${user_parameter}"
		fi
	fi

	return 0
}

lib_rm_jailparam()
{
	local _o

	# options
	local opt_all=0
	local opt_ignore_unkvars=0
	local opt_all_rows=0
	local parameter=
	# column
	local column=0
	# row
	local current_row=-1 row=0

	# misc
	local found=0

	if [ $# -eq 0 ]; then
		lib_err ${EX_USAGE} "usage: lib_rm_jailparam -A | -a parameter [-iP] [-C column] [-R row]"
	fi
	
	while getopts ":AiPa:C:R:" _o; do
		case "${_o}" in
			A)
				opt_all=1
				;;
			i)
				opt_ignore_unkvars=1
				;;
			P)
				opt_all_rows=1
				;;
			a)
				parameter="${OPTARG}"
				;;
			C)
				column="${OPTARG}"
				;;
			R)
				row="${OPTARG}"
				;;
			*)
				lib_rm_jailparam # usage
				;;
		esac
	done

	if [ ${opt_all} -eq 0 ]; then
		if [ -z "${parameter}" ]; then
			lib_rm_jailparam # usage
		fi
	fi

	if ! lib_check_number "${column}"; then
		lib_err ${EX_DATAERR} "${column} is an invalid column."
	fi

	if ! lib_check_number "${row}" ; then
		lib_err ${EX_DATAERR} "${row} is an invalid row."
	fi

	if [ ! -f "${template}" ]; then
		lib_err ${EX_NOINPUT} "Cannot find the template \`${template}\`."
	fi

	if [ ${opt_all} -eq 0 ]; then
		parameter=`lib_jailparam_name "${parameter}" =`
		if ! lib_check_jailparam "${parameter}"; then
			lib_err ${EX_DATAERR} "Invalid parameter: ${parameter}"
		fi
	fi

	local jail_args
	while IFS= read -r jail_args; do
		# Empty
		if lib_check_empty "${jail_args}"; then
			printf "%s\n" "${jail_args}"
			continue
		fi
		
		# Comments
		if lib_check_comment "${jail_args}"; then
			printf "%s\n" "${jail_args}"
			continue
		fi

		local jail_parameter=`lib_jailparam_name "${jail_args}" :`
		local jail_parameter_raw=`_lib_wipe_jailparam "${jail_parameter}"`

		if ! lib_check_jailparam "${jail_parameter_raw}"; then
			lib_err ${EX_DATAERR} "Invalid parameter: ${jail_parameter_raw}"
		fi

		# all parameters
		if [ ${opt_all} -eq 1 ]; then
			continue
		fi

		# individual parameters
		if [ "${jail_parameter_raw}" != "${parameter}" ]; then
			printf "%s\n" "${jail_args}"
			continue
		fi

		if [ ${opt_all_rows} -eq 1 ]; then
			found=1
			continue
		fi

		current_row=$((current_row+1))

		if [ ${current_row} -ne ${row} ]; then
			printf "%s\n" "${jail_args}"
			continue
		fi

		found=1

		if [ ${column} -eq 0 ]; then
			continue
		fi

		local jail_value=`lib_jailparam_value "${jail_args}" : | sed -Ee 's/^[[:space:]]//'`

		# Remove if empty
		if [ -z "${jail_value}" ]; then
			continue
		fi

		local columns=`lib_split_ujailparams "${jail_value}"`
		local column_total=`printf "%s\n" "${columns}" | wc -l`

		if [ ${column} -gt ${column_total} ]; then
			if [ ${opt_ignore_unkvars} -eq 0 ]; then
				lib_err ${EX_DATAERR} "Column index (${jail_parameter}:${column}) out of range."
			fi

			return ${EX_DATAERR}
		fi

		# A bit of optimization
		if [ ${column} -eq 1 -a ${column_total} -eq 1 ]; then
			continue
		fi

		printf "%s" "${jail_parameter}: "

		local current_column=0
		printf "%s\n" "${columns}" | while IFS= read -r column_value; do
			current_column=$((current_column+1))

			if [ ${current_column} -ne ${column} ]; then
				printf "%s" "${column_value}"

				if [ ${current_column} -lt ${column_total} ]; then
					if [ ${column} -ne ${column_total} -o $((current_column+1)) -lt ${column_total} ]; then
						printf "%s" " "
					fi
				fi
			fi
		done
		echo
	done

	if [ ${opt_all} -eq 0 -a ${found} -eq 0 ]; then
		if [ ${opt_ignore_unkvars} -eq 0 ]; then
			lib_err ${EX_DATAERR} "Unknown variable '${parameter}:(${row}:${column})'"
		fi

		return ${EX_DATAERR}
	fi

	return 0
}

lib_get_jailcolumn()
{
	local column_value
	local current_column=0
	local columns="$1"
	local column2search="$2"

	if [ -z "${columns}" -o -z "${column2search}" ]; then
		lib_err ${EX_USAGE} "usage: lib_get_jailcolumn columns column2search"
	fi

	printf "%s\n" "${columns}" | while IFS= read -r column_value; do
		current_column=$((current_column+1))

		if [ ${current_column} -ne ${column} ]; then
			continue
		fi

		printf "%s\n" "${column_value}"

		break
	done
}

lib_jailparam_name()
{
	local args="$1"
	local separator="$2"
	local parameter

	if [ -z "${args}" -o -z "${separator}" ]; then
		lib_err ${EX_USAGE} "usage: lib_jailparam_name args separator"
	fi

	args=`printf "%s" "${args}" | sed -Ee 's/^[[:space:]]*//'`
	parameter=`printf "%s" "${args}" | cut -s -d "${separator}" -f1`
	if [ -z "${parameter}" ]; then
		parameter="${args}"
	fi

	printf "%s" "${parameter}"
}

lib_jailparam_value()
{
	local args="$1"
	local separator="$2"

	if [ -z "${args}" -o -z "${separator}" ]; then
		lib_err ${EX_USAGE} "usage: lib_jailparam_value args separator"
	fi

	printf "%s" "${args}" | cut -s -d "${separator}" -f2-
}

_lib_wipe_jailparam()
{
	local parameter="$1"

	if [ -z "${parameter}" ]; then
		lib_err ${EX_USAGE} "usage: _lib_wipe_jailparam parameter"
	fi

	parameter=`printf "%s" "${parameter}" | sed -Ee 's/\+$//' -e 's/^\*//'`

	printf "%s" "${parameter}"
}

_lib_jailparam_printparam()
{
	local jail_parameter="$1"
	local jail_value="$2"
	local opt_show_name="${3:-1}"
	local opt_show_value="${4:-1}"

	if [ -z "${jail_parameter}" ]; then
		lib_err ${EX_USAGE} "usage: _lib_jailparam_printparam jail_parameter [jail_value] [show_name?] [show_value?]"
	fi

	if [ ${opt_show_name} -eq 1 ]; then
		printf "%s" "${jail_parameter}"
	fi
	if [ ${opt_show_name} -eq 1 -a ${opt_show_value} -eq 1 ]; then
		printf "%s" ": "
	fi
	if [ ${opt_show_value} -eq 1 ]; then
		printf "%s" "${jail_value}"
	fi
	echo
}

lib_split_jailparams()
{
	local parameter="$1"

	if [ -z "${parameter}" ]; then
		lib_err ${EX_USAGE} "usage: lib_split_jailparams parameter"
	fi

	lib_split_sjailparams "${parameter}" | sed -Ee $'s/^["]//' -e $'s/["]$//'
}

lib_split_sjailparams()
{

	local parameter="$1"

	if [ -z "${parameter}" ]; then
		lib_err ${EX_USAGE} "usage: lib_split_jailparams parameter"
	fi

	lib_split_ujailparams "${parameter}" | sed -Ee "s/\\\\([\"])/\1/g"
}

lib_split_ujailparams()
{
	local parameter="$1"

	if [ -z "${parameter}" ]; then
		lib_err ${EX_USAGE} "usage: lib_split_ujailparams parameter"
	fi

	printf "%s" "${parameter}" | grep -Eoe $'[^ ]+' -e $'["]([^"]|\\\\["])+["]'
}

lib_ajconf()
{
    APPJAIL_CONFIG_JAILDIR="${JAILDIR}"; export APPJAIL_CONFIG_JAILDIR

    "${UTILDIR}/appjail-config/appjail-config" "$@"
}
